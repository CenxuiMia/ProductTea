<!DOCTYPE html>
<html lang="en-US">
<head>
	<title>QuickSight via Cognito</title>
	<meta charset="UTF-8">
    <link rel="shortcut icon" type="image/png" href="https://a0.awsstatic.com/main/images/site/favicon.ico"/>	
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css" media="screen,projection">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.96.0.min.js"></script>
	<script src="auth.js"></script>
	<script src="aws-cognito-sdk.js"></script>
	<script src="amazon-cognito-auth.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<body  onload="onLoad()">
	<br/>
	<br/>
	<br/>
    <div class="container">

		<div class="row">
			<div class="col s12 m12">
				<div id="startButtons" class="center-align">
					<div class="button">
						<a class="waves-effect waves-light btn-large blue-grey darken-2 z-depth-5" id="signInButton" href="javascript:void(0)" title="Sign in">Sign In / Sign Up</a>
					</div>
				</div>
			</div>
		</div>

    </div>
	<script>
	AWS.config.update({
		region: region,
		credentials: new AWS.CognitoIdentityCredentials({
		IdentityPoolId: ''
		})
	});

	AWSCognito.config.region = region;


	AWSCognito.config.credentials = new AWS.CognitoIdentityCredentials({
			IdentityPoolId: identityPool 
	});

	AWSCognito.config.update({accessKeyId: 'null', secretAccessKey: 'null'});
	// Operations when the web page is loaded.
	function onLoad() {
		// Initiatlize CognitoAuth object
		var auth = initCognitoSDK();
		document.getElementById("signInButton").addEventListener("click", function() {
			userButton(auth);
		});
		var curUrl = window.location.href;
		auth.parseCognitoWebResponse(curUrl);
	}

  // Operations when signed in.
  function showSignedIn(session) {
		//todo
	}

  // Perform user operations.
	function userButton(auth) {
		var state = document.getElementById('signInButton').innerHTML;
        var statestr = state.toString();
		if (statestr.includes("Sign Out")) {
			document.getElementById("signInButton").innerHTML = "Sign In";
			auth.signOut();
			showSignedOut();
		} else {
			auth.getSession();
		}
	}

  // Initialize a cognito auth object.
	function initCognitoSDK() {
		let auth = new AWSCognito.CognitoIdentityServiceProvider.CognitoAuth(authData);
		auth.userhandler = {
			onSuccess: function(result) {
				console.log("Cognito Sign in successful!");
				showSignedIn(result);
				let id_token = auth.signInUserSession.idToken.jwtToken;
				let cognitoParams = {
					IdentityPoolId: identityPool,
					Logins: {}
				};
				cognitoParams.Logins["cognito-idp."+region+".amazonaws.com/"+poolId] = id_token;
				AWS.config.credentials = new AWS.CognitoIdentityCredentials(cognitoParams);
				AWS.config.getCredentials(function(){
					let req = new XMLHttpRequest();
					let creds = {
						"sessionId":AWS.config.credentials.accessKeyId,
						"sessionKey":AWS.config.credentials.secretAccessKey,
						"sessionToken":AWS.config.credentials.sessionToken
					}
					let credsEncoded = encodeURIComponent(JSON.stringify(creds));
					
				});

				//implement here
			},
			onFailure: function(err) {
				console.log("Error!" + err);
				auth.signOut();
			}
		};
		// The default response_type is "token", uncomment the next line will make it be "code".
		// auth.useCodeGrantFlow();
		return auth;
	}
	</script>
</body>
</html>